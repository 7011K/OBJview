<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>OBJ→HTML 変換ツール</title>
<style>
body { font-family: sans-serif; margin:30px; }
input[type=file] { margin:10px; }
#output { margin-top:20px; }
</style>
</head>
<body>
<h2>OBJ→HTML変換ツール</h2>
<p>OBJ, MTL, テクスチャ画像を選択して「表示用HTML生成」ボタンを押してください。</p>
OBJファイル: <input type="file" id="objFile" accept=".obj"><br>
MTLファイル: <input type="file" id="mtlFile" accept=".mtl"><br>
テクスチャ画像: <input type="file" id="imgFile" multiple accept="image/*"><br>
<button id="generateBtn">表示用HTML生成＆ダウンロード</button>
<div id="output"></div>
<script>
// Three.js CDN（必要ならローカル保存版に変更可能）
const THREEJS_URL = "https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.min.js";
const OBJLOADER_URL = "https://cdn.jsdelivr.net/npm/three@0.154.0/examples/js/loaders/OBJLoader.js";
const MTLLOADER_URL = "https://cdn.jsdelivr.net/npm/three@0.154.0/examples/js/loaders/MTLLoader.js";

// ファイル読込
function readFile(file, as='text') {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(reader.result);
        reader.onerror = reject;
        as==='text' ? reader.readAsText(file) : reader.readAsDataURL(file);
    });
}

document.getElementById('generateBtn').onclick = async function() {
    const objFile = document.getElementById('objFile').files[0];
    const mtlFile = document.getElementById('mtlFile').files[0];
    const imgFiles = Array.from(document.getElementById('imgFile').files);

    if (!objFile) { alert('OBJファイルを選択してください'); return; }

    // ファイル読込
    const objText = await readFile(objFile, 'text');
    let mtlText = '';
    if (mtlFile) mtlText = await readFile(mtlFile, 'text');

    // 画像は base64 に
    const imgMap = {};
    for (const img of imgFiles) {
        const dataUrl = await readFile(img, 'data');
        imgMap[img.name] = dataUrl;
    }

    // HTML生成
    const html = makeModelHtml(objText, mtlText, imgMap);
    const blob = new Blob([html], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'model_viewer.html';
    a.textContent = 'ダウンロード: model_viewer.html';
    document.getElementById('output').innerHTML = '';
    document.getElementById('output').appendChild(a);
    a.click();
    setTimeout(()=>URL.revokeObjectURL(url),10000);
};

// HTML生成ロジック
function makeModelHtml(objText, mtlText, imgMap) {
    // テクスチャ画像をbase64で置き換える
    // MTL内の「map_Kd テクスチャ名」をbase64に
    let mtlTextEmbed = mtlText;
    for (const fname in imgMap) {
        // map_Kd .../fname
        mtlTextEmbed = mtlTextEmbed.replace(
            new RegExp(`map_Kd\\s+.*${fname}`,'g'),
            `map_Kd ${imgMap[fname]}`
        );
    }

    // OBJ/MTLをbase64で埋め込み
    const objBase64 = btoa(unescape(encodeURIComponent(objText)));
    const mtlBase64 = mtlText ? btoa(unescape(encodeURIComponent(mtlTextEmbed))) : '';

    return `<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>OBJモデル表示ビューア（Three.js）</title>
<style>body{margin:0;overflow:hidden;}canvas{width:100vw;height:100vh;display:block;}</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div style="position:fixed;top:10px;left:10px;z-index:10;background:rgba(255,255,255,0.8);padding:8px;border-radius:8px;">
    <span id="tree"></span>
</div>
<script src="${THREEJS_URL}"></script>
<script src="${MTLLOADER_URL}"></script>
<script src="${OBJLOADER_URL}"></script>
<script>
// OBJ/MTL base64データ
const objData = decodeURIComponent(escape(atob("${objBase64}")));
${mtlText ? 'const mtlData = decodeURIComponent(escape(atob("' + mtlBase64 + '")));' : ''}

// DataLoader: テキストをThree.js Loaderに渡すための仮想ファイル
class TextLoader {
    constructor(text) { this.text = text; }
    load(url, onLoad) { onLoad(this.text); }
}

function createScene() {
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0,2,6);

    const renderer = new THREE.WebGLRenderer({canvas:document.getElementById('canvas'),antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);

    // 環境光 & ライト
    scene.add(new THREE.AmbientLight(0xffffff,0.6));
    const dirLight = new THREE.DirectionalLight(0xffffff,0.8);
    dirLight.position.set(5,10,10);
    scene.add(dirLight);

    // コントロール
    let controls;
    try {
        // OrbitControls が利用できる場合（CDNなどで追加）
        controls = new THREE.OrbitControls(camera, renderer.domElement);
    } catch(e) {
        // なくても表示は可能
    }

    // OBJ/MTLローダー
    function loadOBJMTL() {
        // テクスチャ画像のbase64は MTL内で map_Kd data:image... になっているので Three.js が自動読込
        if (${mtlText ? 'true' : 'false'}) {
            const mtlLoader = new THREE.MTLLoader();
            mtlLoader.load = (url, onLoad) => onLoad(mtlData); // 差し替え
            mtlLoader.load('', materials => {
                materials.preload();
                const objLoader = new THREE.OBJLoader();
                objLoader.setMaterials(materials);
                objLoader.load = (url, onLoad) => onLoad(objData);
                objLoader.load('', obj => {
                    scene.add(obj);
                    setupTree(obj);
                });
            });
        } else {
            const objLoader = new THREE.OBJLoader();
            objLoader.load = (url, onLoad) => onLoad(objData);
            objLoader.load('', obj => {
                scene.add(obj);
                setupTree(obj);
            });
        }
    }

    loadOBJMTL();

    // 再描画
    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
        if (controls) controls.update();
    }
    animate();

    // 階層構造ツリーUI
    function setupTree(objRoot) {
        const treeDiv = document.getElementById('tree');
        function buildTree(obj, depth=0) {
            const div = document.createElement('div');
            div.style.marginLeft = (depth*14) + "px";
            // パーツ名
            let name = obj.name || obj.type;
            if (!name) name = '[Mesh]';
            // 表示/非表示
            const chk = document.createElement('input');
            chk.type = 'checkbox';
            chk.checked = obj.visible;
            chk.onchange = ()=>{ obj.visible = chk.checked; };
            div.appendChild(chk);
            div.appendChild(document.createTextNode(' ' + name));
            treeDiv.appendChild(div);
            // 再帰
            if (obj.children) {
                for (const child of obj.children) {
                    buildTree(child, depth+1);
                }
            }
        }
        treeDiv.innerHTML = '';
        buildTree(objRoot, 0);
    }
}
createScene();
</script>
</body>
</html>
`;
}
</script>
</body>
</html>
